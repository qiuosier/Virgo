# Decrypt the file containing the key
steps:
- name: 'gcr.io/cloud-builders/gsutil'
  args:
  - cp
  - 'gs://qqin.page/Keys/cloud_build.enc'
  - 'cloud_build.enc'
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - kms
  - decrypt
  - --ciphertext-file=cloud_build.enc
  - --plaintext-file=/root/.ssh/cloud_build
  - --location=global
  - --keyring=cloud-build-keyring
  - --key=cloud-build-key
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# Set up git with key and domain
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    chmod 600 /root/.ssh/cloud_build
    cat <<EOF >/root/.ssh/config
    Hostname 35.196.143.123
    IdentityFile /root/.ssh/cloud_build
    EOF
    mv known_hosts /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# Clone the repository
- name: 'gcr.io/cloud-builders/git'
  args:
  - submodule
  - update
  - --init
  - --recursive
  volumes:
  - name: 'ssh'
    path: /root/.ssh

  # Copy the files to server
  - name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  'rsync -r --exclude-from=$WORKSPACE/.gitignore $WORKSPACE/ jenkins@104.196.107.63:/mnt/disks/image-creator/who_demo --delete'
  args:
  - 'rsync'
  - -r
  - .
  - service-403422450929@35.196.143.123:/var/virgo --delete
  volumes:
  - name: 'ssh'
    path: /root/.ssh